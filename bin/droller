#!/usr/bin/env bash

DIRECTORY="$HOME/.config/droller"
INDEX="$DIRECTORY/index"
HEAD="$DIRECTORY/head"

main() {
    createFiles

    case $1 in
        "status"|"s")
            checkStatus; exit ;;
        "open"|"o")
            openSelectedRecord;;
        "+1"|"1")
            echo "one plus";;
        "-1"|"-")
            echo "one minus";;
        "top"|"t")
            echo "select top";;
        "random"|"r"|"")
            selectRandomRecord
            checkStatus
            ;;
        "edit"|"e")
            echo "edit HEAD";;
        "add"|"a")
            addRecord $2;;
        "delete"|"d")
            checkStatus
            deleteSelectedRecord
            selectRandomRecord
            checkStatus
            ;;
        "help"|"h")
            echo "help";;
        *)
            addRecord $1;;
    esac
}

createFiles() {
    if [ ! -d "$DIRECTORY" ]; then
        mkdir -p $DIRECTORY
    fi
    if [ ! -f "$INDEX" ]; then
        touch $INDEX
    fi
    if [ ! -f "$HEAD" ]; then
        touch $HEAD
    fi
}

checkStatus() {
    head -1 $HEAD | cut -c 42-
}

openSelectedRecord() {
    head -1 $HEAD | sed -E "s/^.*] http/http/" | xargs open
}

addRecord() {
    uri="$1"
    hash=`getHash $uri`

    if [ `isExistHash $hash` == "1" ]; then
        echo "The record already exists."
        selectRecord $hash
        return 0;
    fi
    saveRecord $hash $uri
    echo "A record has been added."
    selectRecord $hash
    checkStatus
}

deleteSelectedRecord() {
    hash=`head -1 $HEAD | cut -d ' ' -f1`
    grep -v $hash $INDEX > $INDEX.old
    cat $INDEX.old > $INDEX
    echo "The record has been deleted."
}

selectRandomRecord() {
    sort -R $INDEX | head -1  > $HEAD
}

getHash() {
    openssl sha1 <<< $1
}

isExistHash() {
    hash="$1"; grep $hash $INDEX | wc -l | tr -d ' '
}

selectRecord() {
    hash="$1"; grep $hash $INDEX | head -1 > $HEAD
}

saveRecord() {
    hash="$1"; uri="$2"; point="0"
    title=`getTitleFromUri $uri`
    printf "%s %s %s %s\n" $hash $point "[$title]" $uri >> $INDEX
}

getTitleFromUri() {
    uri="$1"
    curl -s $uri | egrep -o '<title>[^<]*?</title>' | sed -E 's,</?title>,,g'
}

main $@

